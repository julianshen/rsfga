# RSFGA Multi-Backend Compatibility Test Report

**Generated:** 2026-01-17
**Test Environment:** Kubernetes (Orbstack) on macOS

---

## Executive Summary

This report documents RSFGA compatibility testing across 4 storage backends deployed in Kubernetes:

| Backend | Status | Tests Passed | Tests Failed | Notes |
|---------|--------|--------------|--------------|-------|
| PostgreSQL | ✅ Running | 43 | 207 | Primary supported backend |
| CockroachDB | ❌ Migration Failed | - | - | ALTER TABLE in function not supported |
| MariaDB | ❌ Migration Failed | - | - | Index key length exceeded |
| TiDB | ❌ Migration Failed | - | - | Index key length exceeded |

---

## Backend Details

### PostgreSQL (Port 30081) ✅

**Status:** Running and accepting requests

**Test Results:**
- **Total Passed:** 43
- **Total Failed:** 207

**Passing Test Sections:**
| Section | Description | Passed | Failed |
|---------|-------------|--------|--------|
| Section 2 | Health/Info API | 9 | 0 |
| Section 3 | Store CRUD | 8 | 0 |
| Section 18 | Rate Limiting | 3 | 0 |
| Section 34 | Streamed ListObjects | 5 | 0 |
| Section 35 | Modular Models | 5 | 2 |

**Analysis:**
The PostgreSQL backend is operational with basic store management and health endpoints working correctly. Many features are still in development as RSFGA is in Phase 1 implementation. The failing tests cover:
- Check API (authorization resolution)
- Tuple write/read operations
- gRPC endpoints
- CEL condition support
- Complex authorization models

---

### CockroachDB (Port 30082) ❌

**Status:** Migration Failed - Pod in CrashLoopBackOff

**Error:**
```
unimplemented: ALTER TABLE usage inside a function definition is not supported
```

**Root Cause:**
CockroachDB does not support `ALTER TABLE` statements inside PL/pgSQL function definitions. The RSFGA migration uses idempotent migration functions that include `ALTER TABLE` commands.

**Remediation Options:**
1. Create separate migration scripts for CockroachDB
2. Modify migration strategy to avoid `ALTER TABLE` in functions
3. Use conditional migration paths based on database type

---

### MariaDB (Port 30083) ❌

**Status:** Migration Failed - Pod in CrashLoopBackOff

**Error:**
```
1071 (42000): Specified key was too long; max key length is 3072 bytes
```

**Root Cause:**
The composite index on the tuples table exceeds MariaDB's default maximum key length. With `utf8mb4` encoding (4 bytes per character), large VARCHAR columns create indexes that exceed the 3072-byte limit.

**Remediation Options:**
1. Reduce column sizes in indexes
2. Use prefix indexes (e.g., `INDEX(column(191))`)
3. Change character set to `utf8` (3 bytes) for indexed columns
4. Configure MariaDB with `innodb_large_prefix=ON`

---

### TiDB (Port 30084) ❌

**Status:** Migration Failed - Pod in CrashLoopBackOff

**Error:**
```
Specified key was too long; max key length is 3072 bytes
```

**Root Cause:**
Same as MariaDB - TiDB inherits MySQL's index key length limitations.

**Remediation Options:**
Same as MariaDB options above.

---

## Kubernetes Deployment Details

**Namespace:** `rsfga-test`

**Services:**
```
NAME                TYPE       CLUSTER-IP        PORT(S)          NODE-PORT
rsfga-postgres      NodePort   192.168.194.233   8080:30081/TCP   30081
rsfga-cockroachdb   NodePort   192.168.194.210   8080:30082/TCP   30082
rsfga-mariadb       NodePort   192.168.194.226   8080:30083/TCP   30083
rsfga-tidb          NodePort   192.168.194.147   8080:30084/TCP   30084
```

**Pod Status:**
```
NAME                              READY   STATUS
postgres-xxx                      1/1     Running
rsfga-postgres-xxx               1/1     Running
cockroachdb-xxx                  1/1     Running
rsfga-cockroachdb-xxx            0/1     CrashLoopBackOff
mariadb-xxx                      1/1     Running
rsfga-mariadb-xxx                0/1     CrashLoopBackOff
tidb-xxx                         1/1     Running
rsfga-tidb-xxx                   0/1     CrashLoopBackOff
```

---

## Recommendations

### Short-term
1. **Focus on PostgreSQL** as the primary supported backend
2. Document PostgreSQL as the recommended production database
3. Continue Phase 1 implementation to increase test pass rate

### Medium-term
1. **Create database-specific migrations** for CockroachDB compatibility
2. **Implement prefix indexing** for MySQL-family databases
3. Add database compatibility matrix to documentation

### Long-term
1. **Add CI pipeline** for multi-backend testing
2. **Implement database feature detection** at startup
3. Consider **abstract storage layer** that handles dialect differences

---

## Files Generated

- `postgres_20260117_093103.txt` - Full PostgreSQL test output
- `SUMMARY_20260117.md` - This summary report

---

## Test Infrastructure

**k8s Manifests Location:** `/Users/julianshen/prj/rsfga/k8s-test/`

- `namespace.yaml` - rsfga-test namespace
- `databases.yaml` - PostgreSQL, CockroachDB, MariaDB, TiDB deployments
- `rsfga-deployments.yaml` - RSFGA instances with backend configuration
- `run-backend-tests.sh` - Test runner script

**Commands:**
```bash
# Deploy infrastructure
kubectl apply -f k8s-test/namespace.yaml
kubectl apply -f k8s-test/databases.yaml
kubectl apply -f k8s-test/rsfga-deployments.yaml

# Run tests
./k8s-test/run-backend-tests.sh postgres

# Cleanup
kubectl delete namespace rsfga-test
```
